# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# NeuroForge RP2040 Blink Test - AUTO-PATCH VERSION
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

using sysbus

mach create "pico"

# Carregar plataforma base estÃ¡vel (MappedMemory)
machine LoadPlatformDescription "D:/Documents/NeuroForge/server/test-firmware/rp2040/blink/platforms/raspberry-pico.repl"

# SIO_CPUID (SIO_BASE + 0) -> 0x0 para o Core 0
sysbus Tag <0xd0000000 4> "SIO_CPUID" 0x0

# RESET_DONE (RESETS_BASE + 8) -> 0xFFFFFFFF (All peripherals out of reset)
sysbus Tag <0x4000C008 4> "RESET_DONE" 0xFFFFFFFF

# XOSC_STATUS (XOSC_BASE + 4) -> 0x80000000 (STABLE bit set)
sysbus Tag <0x40024004 4> "XOSC_STATUS" 0x80000000

# PLL_SYS_CS (PLL_SYS_BASE + 0) -> 0x80000000 (LOCK bit set)
sysbus Tag <0x40028000 4> "PLL_SYS_CS" 0x80000000

# PLL_USB_CS (PLL_USB_BASE + 0) -> 0x80000000 (LOCK bit set)
sysbus Tag <0x4002C000 4> "PLL_USB_CS" 0x80000000

# CLOCKS_WAKE_EN (CLOCKS_BASE + 0x30?) -> 0xFFFFFFFF
sysbus Tag <0x40008030 4> "CLOCKS_WAKE" 0xFFFFFFFF

# =========================================================
# TIMER FIX: Patch via Python Script auto-registrÃ¡vel
# =========================================================
# O script abaixo define a lÃ³gica e registra os hooks na cpu0
i @D:/Documents/NeuroForge/server/test-firmware/rp2040/blink/timer_patch.py

# =========================================================
# CARREGAR FIRMWARE
# =========================================================
sysbus LoadELF "D:/Documents/NeuroForge/server/test-firmware/rp2040/blink/build/blink.elf"

# Setup dos registradores para o ponto de entrada real do binÃ¡rio
# Entry point: 0x100001e9 (conforme readelf)
sysbus.cpu0 VectorTableOffset 0x10000100
sysbus.cpu0 SP 0x20042000
sysbus.cpu0 PC 0x100001e9

# =========================================================
# CONFIGURAÃ‡ÃƒO DE UART
# =========================================================
emulation CreateServerSocketTerminal 1234 "uart0-terminal" false
connector Connect sysbus.uart0 uart0-terminal

# Clock configuration
sysbus.cpu0 PerformanceInMips 125

start

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  ğŸš€ NeuroForge RP2040 SDK Simulation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Mode: MappedMemory + Auto-Patch Python"
echo "  Timer: Emulated via instruction hooks"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… EmulaÃ§Ã£o iniciada!"
